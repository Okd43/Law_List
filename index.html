
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法律書選書マネージャー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans JP', sans-serif;
            background-color: #f7f9fc;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Material Motion */
        .transition-standard {
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        .fab {
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="text-slate-900 pb-24">

    <!-- App Bar -->
    <header class="sticky top-0 z-40 bg-[#f7f9fc]/80 backdrop-blur-md px-4 py-4 md:px-6">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-indigo-600 rounded-lg text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    </div>
                    <h1 class="text-lg font-bold tracking-tight">法律書選書</h1>
                </div>
                <!-- 期間表示 -->
                <div class="flex items-center gap-1.5 mt-1 ml-0.5 text-[11px] font-medium text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span>2025/12/21</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    <span class="text-indigo-600 bg-indigo-50 px-1 rounded">2026/01/21 (現在)</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    <span>2026/03/21</span>
                </div>
            </div>
            <button onclick="exportCSV()" class="p-2.5 text-slate-500 hover:bg-slate-200 rounded-full transition-standard">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-6">
        <!-- Quick Sync Button -->
        <button id="sync-btn" onclick="fetchBooks()" class="w-full mb-8 p-6 bg-white border border-indigo-100 text-indigo-700 rounded-[28px] flex items-center justify-between shadow-sm transition-standard active:scale-[0.98] hover:bg-indigo-50">
            <div class="flex items-center gap-4">
                <div id="sync-icon-container" class="p-3 bg-indigo-100 text-indigo-600 rounded-2xl">
                    <svg id="sync-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                </div>
                <div class="text-left">
                    <p class="text-sm font-bold opacity-70">データベース同期</p>
                    <p class="text-xs">最新の出版情報を取得します</p>
                </div>
            </div>
            <div class="text-right">
                <span id="total-count" class="text-2xl font-black">0</span>
                <span class="text-xs ml-1 font-bold opacity-60">冊</span>
            </div>
        </button>

        <!-- Progress -->
        <div id="progress-container" class="hidden mb-8 bg-white p-5 rounded-[24px] border border-indigo-50">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold text-indigo-600">同期中...</span>
                <span id="sync-percent" class="text-xs font-mono font-bold text-indigo-600">0%</span>
            </div>
            <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="sync-bar" class="h-full bg-indigo-600 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Chips -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setFilter('all')" id="chip-all" class="px-5 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-indigo-600 text-white shadow-md shadow-indigo-100">すべて</button>
            <button onclick="setFilter('future')" id="chip-future" class="px-5 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-white text-slate-500 border border-slate-200 hover:bg-slate-50">発売予定</button>
            <button onclick="setFilter('past')" id="chip-past" class="px-5 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-white text-slate-500 border border-slate-200 hover:bg-slate-50">既刊</button>
        </div>

        <!-- List -->
        <div id="book-list" class="space-y-3">
            <!-- Cards will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden py-20 text-center flex flex-col items-center">
            <div class="bg-slate-50 p-5 rounded-full mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </div>
            <p class="text-slate-400 text-sm font-bold tracking-tight">書籍が見つかりません</p>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="toggleModal(true)" class="fab fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-[20px] shadow-xl flex items-center justify-center hover:bg-indigo-700 transition-standard active:scale-90 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-end md:items-center justify-center p-0 md:p-4 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-t-[32px] md:rounded-[32px] overflow-hidden shadow-2xl transition-all duration-300">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-lg font-black text-slate-800 tracking-tight">手動で追加</h2>
                <button onclick="toggleModal(false)" class="p-2 text-slate-400 hover:bg-white rounded-full transition-standard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <form id="manual-form" class="p-8 space-y-5">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-black text-indigo-600 uppercase ml-1">書名</label>
                    <input type="text" id="m-title" required placeholder="例：会社法詳解 第3版" class="w-full bg-slate-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-indigo-600 outline-none transition-standard">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-1">出版社</label>
                        <input type="text" id="m-publisher" placeholder="有斐閣" class="w-full bg-slate-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-indigo-600 outline-none transition-standard">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-1">発売日</label>
                        <input type="date" id="m-date" required class="w-full bg-slate-50 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-indigo-600 outline-none transition-standard">
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleModal(false)" class="flex-1 py-4 text-slate-500 font-bold rounded-2xl hover:bg-slate-50 transition-standard">閉じる</button>
                    <button type="submit" class="flex-2 py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-standard px-8">追加する</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const TODAY = new Date('2026-01-21');
        const PAST_LIMIT = new Date('2025-12-21');
        const FUTURE_LIMIT = new Date('2026-03-21');

        let books = JSON.parse(localStorage.getItem('law_books_v10')) || [];
        let currentFilter = 'all';
        let isSyncing = false;

        const lawPublishers = ["有斐閣", "弘文堂", "商事法務", "成文堂", "信山社", "日本評論社", "立花書房", "三省堂", "ぎょうせい", "第一法規", "新日本法規", "東京大学出版会", "勁草書房", "法学書院", "中央経済社"];
        const lawKeywords = ["法律", "民法", "刑法", "憲法", "行政法", "訴訟法", "商法", "会社法", "司法試験", "判例", "条文", "六法", "実務", "弁護士", "法学", "民事", "刑事", "契約", "法務"];

        function save() {
            localStorage.setItem('law_books_v10', JSON.stringify(books));
        }

        function toggleModal(show) {
            const modal = document.getElementById('modal');
            if (show) {
                modal.classList.remove('hidden');
                document.getElementById('m-title').focus();
            } else {
                modal.classList.add('hidden');
            }
        }

        async function fetchBooks() {
            if (isSyncing) return;
            isSyncing = true;
            
            const btn = document.getElementById('sync-btn');
            const icon = document.getElementById('sync-icon');
            const progressContainer = document.getElementById('progress-container');
            const syncBar = document.getElementById('sync-bar');
            const syncPercent = document.getElementById('sync-percent');

            btn.classList.add('opacity-50', 'pointer-events-none');
            icon.classList.add('animate-spin');
            progressContainer.classList.remove('hidden');

            try {
                const covRes = await fetch('https://api.openbd.jp/v1/coverage');
                const allIsbns = await covRes.json();
                const targetIsbns = allIsbns.slice(-1000);
                const chunks = [];
                for (let i = 0; i < targetIsbns.length; i += 100) chunks.push(targetIsbns.slice(i, i + 100));
                
                for (let i = 0; i < chunks.length; i++) {
                    const dataRes = await fetch(`https://api.openbd.jp/v1/get?isbn=${chunks[i].join(',')}`);
                    const data = await dataRes.json();
                    
                    if (data) {
                        data.forEach(item => {
                            if (!item || !item.summary) return;
                            const s = item.summary;
                            if (!s.pubdate) return;
                            const rawDate = s.pubdate.replace(/\D/g, '');
                            if (rawDate.length < 8) return;
                            const pubDate = new Date(`${rawDate.slice(0,4)}-${rawDate.slice(4,6)}-${rawDate.slice(6,8)}`);

                            if (pubDate >= PAST_LIMIT && pubDate <= FUTURE_LIMIT) {
                                const isLaw = lawPublishers.some(p => s.publisher.includes(p)) || 
                                              lawKeywords.some(k => s.title.includes(k));
                                
                                if (isLaw && !books.some(b => b.isbn === s.isbn)) {
                                    books.push({
                                        id: Date.now() + Math.random(),
                                        title: s.title,
                                        author: s.author,
                                        publisher: s.publisher,
                                        isbn: s.isbn,
                                        date: `${rawDate.slice(0,4)}-${rawDate.slice(4,6)}-${rawDate.slice(6,8)}`,
                                        type: 'auto'
                                    });
                                }
                            }
                        });
                    }
                    const p = Math.round(((i + 1) / chunks.length) * 100);
                    syncBar.style.width = p + '%';
                    syncPercent.innerText = p + '%';
                }
            } catch (err) {
                console.error(err);
            } finally {
                isSyncing = false;
                btn.classList.remove('opacity-50', 'pointer-events-none');
                icon.classList.remove('animate-spin');
                setTimeout(() => progressContainer.classList.add('hidden'), 1000);
                save();
                render();
            }
        }

        document.getElementById('manual-form').onsubmit = function(e) {
            e.preventDefault();
            const newBook = {
                id: Date.now(),
                title: document.getElementById('m-title').value,
                publisher: document.getElementById('m-publisher').value || '不明',
                date: document.getElementById('m-date').value,
                author: '',
                isbn: '---',
                type: 'manual'
            };
            books.push(newBook);
            save();
            render();
            toggleModal(false);
            e.target.reset();
        };

        function deleteBook(id) {
            books = books.filter(b => b.id !== id);
            save();
            render();
        }

        function setFilter(f) {
            currentFilter = f;
            ['all', 'future', 'past'].forEach(id => {
                const el = document.getElementById(`chip-${id}`);
                if (id === f) {
                    el.className = 'px-5 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-indigo-600 text-white shadow-md shadow-indigo-100';
                } else {
                    el.className = 'px-5 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap bg-white text-slate-500 border border-slate-200 hover:bg-slate-50';
                }
            });
            render();
        }

        function render() {
            const container = document.getElementById('book-list');
            const empty = document.getElementById('empty-state');
            const countEl = document.getElementById('total-count');
            
            container.innerHTML = '';
            
            let filtered = books.filter(b => {
                const bDate = new Date(b.date);
                if (currentFilter === 'future') return bDate > TODAY;
                if (currentFilter === 'past') return bDate <= TODAY;
                return true;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            countEl.innerText = books.length;

            if (filtered.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                filtered.forEach(book => {
                    const isFuture = new Date(book.date) > TODAY;
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-[24px] border border-slate-100 flex items-center gap-4 transition-standard hover:border-indigo-200 group";
                    card.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${isFuture ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}">
                                    ${isFuture ? '予定' : '既刊'}
                                </span>
                                <span class="text-[11px] font-bold text-slate-400 truncate uppercase">${book.publisher}</span>
                                ${book.type === 'manual' ? '<span class="text-[9px] font-bold text-indigo-500 border border-indigo-200 px-1.5 rounded">手動</span>' : ''}
                            </div>
                            <h3 class="font-bold text-slate-800 text-sm truncate pr-2 leading-snug">${book.title}</h3>
                            <div class="flex items-center gap-3 mt-1 text-[11px] text-slate-500 font-medium">
                                <span>${book.date.replace(/-/g, '/')}</span>
                                <span class="opacity-40">|</span>
                                <span class="truncate max-w-[150px]">${book.author || '---'}</span>
                            </div>
                        </div>
                        <button onclick="deleteBook(${book.id})" class="p-2 text-slate-200 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-standard md:opacity-0 group-hover:opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    container.appendChild(card);
                });
            }
        }

        function exportCSV() {
            if (books.length === 0) return;
            const headers = ['時期', '書名', '出版社', '発売日'];
            const rows = books.map(b => [
                (new Date(b.date) > TODAY ? '予定' : '既刊'),
                `"${b.title}"`, `"${b.publisher}"`, b.date
            ]);
            const csv = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `law_books_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        window.onload = render;
    </script>
</body>
</html>